{"id":13,"date":"2023-07-30T11:08:35","date_gmt":"2023-07-30T11:08:35","guid":{"rendered":"http:\/\/192.168.0.149:30000\/?p=13"},"modified":"2023-07-30T11:40:40","modified_gmt":"2023-07-30T11:40:40","slug":"kubernetes-hardway-using-ansible","status":"publish","type":"post","link":"http:\/\/192.168.0.149:30000\/2023\/07\/30\/kubernetes-hardway-using-ansible\/","title":{"rendered":"Kubernetes Hardway using ansible"},"content":{"rendered":"\n<p><strong># k3s-otel-demo<\/strong><\/p>\n\n\n\n<p>sudo apt update<\/p>\n\n\n\n<p>sudo add-apt-repository &#8211;yes &#8211;update ppa:ansible\/ansible<\/p>\n\n\n\n<p>sudo DEBIAN_FRONTEND=noninteractive apt install software-properties-common unzip sshpass python3-pip ansible -y<\/p>\n\n\n\n<p>pip3 install kubernetes<\/p>\n\n\n\n<p>curl -sfL https:\/\/get.k3s.io | K3S_KUBECONFIG_MODE=&#8221;644&#8243; INSTALL_K3S_EXEC=&#8221;server &#8211;disable=traefik&#8221; sh &#8211;<\/p>\n\n\n\n<p>pip3 install locust<\/p>\n\n\n\n<p>sudo cp \/etc\/rancher\/k3s\/k3s.yaml ~\/.kube\/config<\/p>\n\n\n\n<p>kubectl patch svc edgenius-otel-collector &#8211;type=&#8217;json&#8217; -p \\<\/p>\n\n\n\n<p>&#8216;[{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/type&#8221;,&#8221;value&#8221;:&#8221;NodePort&#8221;},{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/ports\/0\/nodePort&#8221;,&#8221;value&#8221;:30000}]&#8217;<\/p>\n\n\n\n<p>kubectl patch svc loki &#8211;type=&#8217;json&#8217; -p \\<\/p>\n\n\n\n<p>&#8216;[{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/type&#8221;,&#8221;value&#8221;:&#8221;NodePort&#8221;},{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/ports\/0\/nodePort&#8221;,&#8221;value&#8221;:30010}]&#8217;<\/p>\n\n\n\n<p>kubectl patch svc cadvisor -n cadvisor &#8211;type=&#8217;json&#8217; -p \\<\/p>\n\n\n\n<p>&#8216;[{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/type&#8221;,&#8221;value&#8221;:&#8221;NodePort&#8221;},{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/ports\/0\/nodePort&#8221;,&#8221;value&#8221;:30011}]&#8217;<\/p>\n\n\n\n<p>kubectl patch svc edgenius-node-exporter &nbsp;&#8211;type=&#8217;json&#8217; -p \\<\/p>\n\n\n\n<p>&#8216;[{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/type&#8221;,&#8221;value&#8221;:&#8221;NodePort&#8221;},{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/ports\/0\/nodePort&#8221;,&#8221;value&#8221;:30002}]&#8217;<\/p>\n\n\n\n<p>kubectl patch svc kube-state-metrics -n kube-system &#8211;type=&#8217;json&#8217; -p \\<\/p>\n\n\n\n<p>&#8216;[{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/type&#8221;,&#8221;value&#8221;:&#8221;NodePort&#8221;},{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/ports\/0\/nodePort&#8221;,&#8221;value&#8221;:30003}]&#8217;<\/p>\n\n\n\n<p>kubectl patch svc edgenius-kb-http &#8211;type=&#8217;json&#8217; -p \\<\/p>\n\n\n\n<p>&#8216;[{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/type&#8221;,&#8221;value&#8221;:&#8221;NodePort&#8221;},{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/ports\/0\/nodePort&#8221;,&#8221;value&#8221;:30011}]&#8217;<\/p>\n\n\n\n<p>kubectl patch svc edgenius-apm-http &#8211;type=&#8217;json&#8217; -p \\<\/p>\n\n\n\n<p>&#8216;[{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/type&#8221;,&#8221;value&#8221;:&#8221;NodePort&#8221;},{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/ports\/0\/nodePort&#8221;,&#8221;value&#8221;:30012}]&#8217;<\/p>\n\n\n\n<p>kubectl patch svc wordpress -n edgenius &#8211;type=&#8217;json&#8217; -p \\<\/p>\n\n\n\n<p>&#8216;[{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/type&#8221;,&#8221;value&#8221;:&#8221;NodePort&#8221;},{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/ports\/0\/nodePort&#8221;,&#8221;value&#8221;:30000}]&#8217;<\/p>\n\n\n\n<p>kubectl get secret edgenius-es-elastic-user -o=jsonpath='{.data.elastic}&#8217; | base64 &#8211;decode; echo<\/p>\n\n\n\n<p>kubectl get secret\/edgenius-apm-token -o go-template='{{index .data &#8220;secret-token&#8221; | base64decode}}&#8217;; echo<\/p>\n\n\n\n<p>curl kube-state-metrics.kube-system.svc.cluster.local:8080\/metrics<\/p>\n\n\n\n<p>curl edgenius-node-exporter.edgenius.svc.cluster.local:9100\/metrics<\/p>\n\n\n\n<p>curl edgenius-node-exporter:9100\/metrics<\/p>\n\n\n\n<p>curl edgenius-otel:8080\/metrics<\/p>\n\n\n\n<p>curl kube-api.kube-system.svc.cluster.local:6443<\/p>\n\n\n\n<p>curl openshift-console.edgenius.svc.cluster.local<\/p>\n\n\n\n<p>sudo kubectl config set-context &#8211;current &#8211;namespace=edgenius<\/p>\n\n\n\n<p>curl -kX POST https:\/\/eck.abb.com\/apm\/ -H &#8220;Authorization: Bearer 70SPJT0a1mGlrfo260F1h3w8&#8221;<\/p>\n\n\n\n<p>http:\/\/prometheus-kube-prometheus-prometheus.observability.svc.cluster.local:9090<\/p>\n\n\n\n<p>helm upgrade mimir grafana\/mimir-distributed -n edgenius -f values.yaml<\/p>\n\n\n\n<p>&#8211; name: apm-server<\/p>\n\n\n\n<p>requests:<\/p>\n\n\n\n<p>memory: 150Mi<\/p>\n\n\n\n<p>cpu: 100m<\/p>\n\n\n\n<p>limits:<\/p>\n\n\n\n<p>memory: 250Mi<\/p>\n\n\n\n<p>cpu: 150m<\/p>\n\n\n\n<p>&#8211; name: elasticsearch<\/p>\n\n\n\n<p>resources:<\/p>\n\n\n\n<p>requests:<\/p>\n\n\n\n<p>memory: 4Gi<\/p>\n\n\n\n<p>cpu: 300m<\/p>\n\n\n\n<p>limits:<\/p>\n\n\n\n<p>memory: 4Gi<\/p>\n\n\n\n<p>cpu: 600m<\/p>\n\n\n\n<p>&#8211; name: kibana<\/p>\n\n\n\n<p>resources:<\/p>\n\n\n\n<p>requests:<\/p>\n\n\n\n<p>memory: 600Mi<\/p>\n\n\n\n<p>cpu: 50m<\/p>\n\n\n\n<p>limits:<\/p>\n\n\n\n<p>memory: 1Gi<\/p>\n\n\n\n<p>cpu: 100m<\/p>\n\n\n\n<p>&#8211; name: assetapi<\/p>\n\n\n\n<p>resources:<\/p>\n\n\n\n<p>requests:<\/p>\n\n\n\n<p>memory: 250Mi<\/p>\n\n\n\n<p>cpu: 50m<\/p>\n\n\n\n<p>limits:<\/p>\n\n\n\n<p>memory: 500Mi<\/p>\n\n\n\n<p>cpu: 100m<\/p>\n\n\n\n<p>&#8211; name: dataapi<\/p>\n\n\n\n<p>resources:<\/p>\n\n\n\n<p>requests:<\/p>\n\n\n\n<p>memory: 150Mi<\/p>\n\n\n\n<p>cpu: &#8220;100m<\/p>\n\n\n\n<p>limits:<\/p>\n\n\n\n<p>memory: 300Mi<\/p>\n\n\n\n<p>cpu: 200m<\/p>\n\n\n\n<p>&nbsp;&#8211; name: eventapi<\/p>\n\n\n\n<p>resources:<\/p>\n\n\n\n<p>requests:<\/p>\n\n\n\n<p>memory: 150Mi<\/p>\n\n\n\n<p>cpu: 20m<\/p>\n\n\n\n<p>limits:<\/p>\n\n\n\n<p>memory: 250Mi<\/p>\n\n\n\n<p>cpu: 50m<\/p>\n\n\n\n<p>&#8211; name: variableapi<\/p>\n\n\n\n<p>resources:<\/p>\n\n\n\n<p>requests:<\/p>\n\n\n\n<p>memory: 250Mi<\/p>\n\n\n\n<p>cpu: 50m<\/p>\n\n\n\n<p>limits:<\/p>\n\n\n\n<p>memory: 400Mi<\/p>\n\n\n\n<p>cpu: 150m<\/p>\n\n\n\n<p>{&#8220;edge_ip&#8221;:&#8221;192.168.0.149&#8243;,&#8221;edge_name&#8221;:&#8221;edge-rinoy&#8221;,&#8221;service.instance.id&#8221;:&#8221;27d38c17-1a84-4334-be9e-659c11b30f59&#8243;,&#8221;service.name&#8221;:&#8221;AssetApi&#8221;,&#8221;telemetry.sdk.language&#8221;:&#8221;dotnet&#8221;,&#8221;telemetry.sdk.name&#8221;:&#8221;opentelemetry&#8221;,&#8221;telemetry.sdk.version&#8221;:&#8221;1.5.0&#8243;}<\/p>\n\n\n\n<p>node_cpu_seconds_total<\/p>\n\n\n\n<p>count(count(node_cpu_seconds_total) by (cpu))<\/p>\n\n\n\n<figure class=\"wp-block-embed\"><div class=\"wp-block-embed__wrapper\">\nhttps:\/\/resume.io\/r\/z6mODq175\n<\/div><\/figure>\n\n\n\n<p>yum install python3.11-pip<\/p>\n\n\n\n<p>\/usr\/bin\/pip3.11 install jmespath<\/p>\n","protected":false},"excerpt":{"rendered":"<p># k3s-otel-demo sudo apt update sudo add-apt-repository &#8211;yes &#8211;update ppa:ansible\/ansible sudo DEBIAN_FRONTEND=noninteractive apt install software-properties-common unzip sshpass python3-pip ansible -y pip3 install kubernetes curl -sfL https:\/\/get.k3s.io | K3S_KUBECONFIG_MODE=&#8221;644&#8243; INSTALL_K3S_EXEC=&#8221;server &#8211;disable=traefik&#8221; sh &#8211; pip3 install locust sudo cp \/etc\/rancher\/k3s\/k3s.yaml ~\/.kube\/config kubectl patch svc edgenius-otel-collector &#8211;type=&#8217;json&#8217; -p \\ &#8216;[{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/type&#8221;,&#8221;value&#8221;:&#8221;NodePort&#8221;},{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/ports\/0\/nodePort&#8221;,&#8221;value&#8221;:30000}]&#8217; kubectl patch svc loki &#8211;type=&#8217;json&#8217; -p \\ &#8216;[{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/type&#8221;,&#8221;value&#8221;:&#8221;NodePort&#8221;},{&#8220;op&#8221;:&#8221;replace&#8221;,&#8221;path&#8221;:&#8221;\/spec\/ports\/0\/nodePort&#8221;,&#8221;value&#8221;:30010}]&#8217; &#8230; <a title=\"Kubernetes Hardway using ansible\" class=\"read-more\" href=\"http:\/\/192.168.0.149:30000\/2023\/07\/30\/kubernetes-hardway-using-ansible\/\" aria-label=\"More on Kubernetes Hardway using ansible\">Read more<\/a><\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[1],"tags":[],"_links":{"self":[{"href":"http:\/\/192.168.0.149:30000\/wp-json\/wp\/v2\/posts\/13"}],"collection":[{"href":"http:\/\/192.168.0.149:30000\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/192.168.0.149:30000\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/192.168.0.149:30000\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"http:\/\/192.168.0.149:30000\/wp-json\/wp\/v2\/comments?post=13"}],"version-history":[{"count":2,"href":"http:\/\/192.168.0.149:30000\/wp-json\/wp\/v2\/posts\/13\/revisions"}],"predecessor-version":[{"id":22,"href":"http:\/\/192.168.0.149:30000\/wp-json\/wp\/v2\/posts\/13\/revisions\/22"}],"wp:attachment":[{"href":"http:\/\/192.168.0.149:30000\/wp-json\/wp\/v2\/media?parent=13"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/192.168.0.149:30000\/wp-json\/wp\/v2\/categories?post=13"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/192.168.0.149:30000\/wp-json\/wp\/v2\/tags?post=13"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}