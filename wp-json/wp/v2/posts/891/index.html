{"id":891,"date":"2023-08-11T11:23:02","date_gmt":"2023-08-11T11:23:02","guid":{"rendered":"http:\/\/192.168.0.142\/?p=891"},"modified":"2023-08-11T12:07:48","modified_gmt":"2023-08-11T12:07:48","slug":"microshift-dynamic-storage-provisioning-using-lvms","status":"publish","type":"post","link":"http:\/\/192.168.0.142\/microshift-dynamic-storage-provisioning-using-lvms\/","title":{"rendered":"MicroShift &#8211; dynamic storage provisioning using LVMS"},"content":{"rendered":"\n<p>MicroShift enables dynamic storage provisioning with the Logical Volume Manager Storage (LVMS) provider. The LVMS plugin is a Container Storage Interface (CSI) plugin for managing LVM volumes for Kubernetes. LVMS provisions new logical volume management (LVM) and logical volumes (LVs) for container workloads with persistent volume claims (PVC). Each PVC references a storage class that represents an LVM Volume Group (VG) on the host node.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\">Prerequisites<\/h3>\n\n\n\n<ul>\n<li>MicroShift 4.13 installed on RHEL 9.2. Please refer <a href=\"http:\/\/192.168.0.142\/installation-of-microshift-4-13-on-redhat-enterprise-linux-9-2\/\" data-type=\"link\" data-id=\"http:\/\/192.168.0.142\/installation-of-microshift-4-13-on-redhat-enterprise-linux-9-2\/\">Microshift 4.13 installation on RedHat Enterprise Linux 9.2<\/a> for further details.<\/li>\n<\/ul>\n\n\n\n<h3 class=\"wp-block-heading\">Configuration<\/h3>\n\n\n\n<p>Add an extra hard disk for dynamic storage provisioning using LVMS. Below is a screen shot of my machine configuration. MicroShift is using second hard disk (scsi1) for LVMS plugin.<\/p>\n\n\n<div class=\"wp-block-image\">\n<figure class=\"aligncenter size-full\"><img decoding=\"async\" loading=\"lazy\" width=\"648\" height=\"350\" src=\"http:\/\/192.168.0.142\/wp-content\/uploads\/2023\/08\/microshift-4-13-lvms-harddisk.png\" alt=\"MicroShift 4.13 LVMS Harddisk \" class=\"wp-image-897\" srcset=\"http:\/\/192.168.0.142\/wp-content\/uploads\/2023\/08\/microshift-4-13-lvms-harddisk.png 648w, http:\/\/192.168.0.142\/wp-content\/uploads\/2023\/08\/microshift-4-13-lvms-harddisk-300x162.png 300w\" sizes=\"(max-width: 648px) 100vw, 648px\" \/><\/figure><\/div>\n\n\n<h4 class=\"wp-block-heading\">Create a volume group<\/h4>\n\n\n\n<p>&nbsp;Check the physical volumes in the machine by running the following command.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\">pvs<\/code><\/pre>\n\n\n\n<p><em>Terminal output for reference<\/em><\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\">[root@localhost hyrule]# pvs\n  PV         VG   Fmt  Attr PSize    PFree\n  \/dev\/sda2  rhel lvm2 a--  &lt;199.00g    0<\/code><\/pre>\n\n\n\n<p>Create a PV. Change physical volume name accordingly by inspecting \/dev folder in the system. In my case its \/dev\/sdb.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\">pvcreate \/dev\/sdb<\/code><\/pre>\n\n\n\n<p><em>Terminal output for reference<\/em><\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\">[root@localhost hyrule]# pvcreate \/dev\/sdb\n  Physical volume \"\/dev\/sdb\" successfully created.\n[root@localhost hyrule]# pvs\n  PV         VG   Fmt  Attr PSize    PFree  \n  \/dev\/sda2  rhel lvm2 a--  &lt;199.00g      0 \n  \/dev\/sdb        lvm2 ---   200.00g 200.00g<\/code><\/pre>\n\n\n\n<p>Create a new volume group<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\">vgcreate hyrule\/dev\/sdb <\/code><\/pre>\n\n\n\n<p><em>Terminal output for reference<\/em><\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\">[root@localhost hyrule]# vgcreate hyrule\/dev\/sdb\n  Volume group \"hyrule\" successfully created<\/code><\/pre>\n\n\n\n<p>Check the pvs in the machine.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\">[root@localhost hyrule]# pvs\n  PV         VG       Fmt  Attr PSize    PFree   \n  \/dev\/sda2  rhel     lvm2 a--  &lt;199.00g       0 \n  \/dev\/sdb   hyrule  lvm2 a--  &lt;200.00g &lt;200.00g<\/code><\/pre>\n\n\n\n<h4 class=\"wp-block-heading\">LVMS Configuration<\/h4>\n\n\n\n<p>Create an LVMS configuration file. When MicroShift runs, it uses LVMS configuration from \/etc\/microshift\/lvmd.yaml. Make sure that volume-group &#8216;hyrule&#8217; is created.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\">sudo cp \/etc\/microshift\/lvmd.yaml.default \/etc\/microshift\/lvmd.yaml<\/code><\/pre>\n\n\n\n<p>Edit \/etc\/microshift\/lvmd.yaml.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\"># Unix domain socket endpoint of gRPC\nsocket-name: \/run\/lvmd\/lvmd.socket\n\ndevice-classes:\n  # The name of a device-class\n  - name: default\n\n    # The group where this device-class creates the logical volumes\n    volume-group: hyrule\n\n    # Storage capacity in GiB to be spared\n    spare-gb: 0\n\n    # A flag to indicate that this device-class is used by default\n    default: true\n\n    # The number of stripes in the logical volume\n    #stripe: \"\"\n\n    # The amount of data that is written to one device before moving to the next device\n    #stripe-size: \"\"\n\n    # Extra arguments to pass to lvcreate, e.g. [\"--type=raid1\"]\n    #lvcreate-options:\n      #- \"\"<\/code><\/pre>\n\n\n\n<p>Restart MicroShift<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\">sudo systemctl start microshift<\/code><\/pre>\n\n\n\n<h3 class=\"wp-block-heading\">Testing<\/h3>\n\n\n\n<p>Create a namespace<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\">oc create ns test<\/code><\/pre>\n\n\n\n<p>Create test.yaml and copy below contents.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"yaml\" class=\"language-yaml\">kind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\n  name: my-lv-pvc\n  namespace: test\nspec:\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 1G\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: my-pod\n  namespace: test\nspec:\n  containers:\n  - name: nginx\n    image: quay.io\/jitesoft\/nginx\n    command: [\"\/bin\/sleep\", \"1d\"]\n    volumeMounts:\n    - mountPath: \/mnt\n      name: my-volume\n    securityContext:\n      allowPrivilegeEscalation: false\n      capabilities:\n        drop:\n          - ALL\n      runAsNonRoot: true\n      seccompProfile:\n        type: RuntimeDefault\n  volumes:\n    - name: my-volume\n      persistentVolumeClaim:\n        claimName: my-lv-pvc<\/code><\/pre>\n\n\n\n<p>Create pvc and pod<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\">oc create -f test.yaml<\/code><\/pre>\n\n\n\n<p>Check the status of pod, pvc and pv.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"bash\" class=\"language-bash\">[hyrule@localhost test]$ oc get po -n test\nNAME     READY   STATUS    RESTARTS   AGE\nmy-pod   1\/1     Running   0          2m7s\n[hyrule@localhost test]$ oc get pvc -n test\nNAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE\nmy-lv-pvc   Bound    pvc-1d6e6430-b052-4c4b-8ff2-df3b23dd9160   1Gi        RWO            topolvm-provisioner   2m13s\n[hyrule@localhost test]$ oc get pv -n test\nNAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM            STORAGECLASS          REASON   AGE\npvc-1d6e6430-b052-4c4b-8ff2-df3b23dd9160   1Gi        RWO            Delete           Bound    test\/my-lv-pvc   topolvm-provisioner            2m19s<\/code><\/pre>\n","protected":false},"excerpt":{"rendered":"<p>MicroShift enables dynamic storage provisioning with the Logical Volume Manager Storage (LVMS) provider. The LVMS plugin is a Container Storage Interface (CSI) plugin for managing LVM volumes for Kubernetes. LVMS provisions new logical volume management (LVM) and logical volumes (LVs) for container workloads with persistent volume claims (PVC). Each PVC references a storage class that &#8230; <a title=\"MicroShift &#8211; dynamic storage provisioning using LVMS\" class=\"read-more\" href=\"http:\/\/192.168.0.142\/microshift-dynamic-storage-provisioning-using-lvms\/\" aria-label=\"More on MicroShift &#8211; dynamic storage provisioning using LVMS\">Read more<\/a><\/p>\n","protected":false},"author":1,"featured_media":249,"comment_status":"closed","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[67],"tags":[68,5],"_links":{"self":[{"href":"http:\/\/192.168.0.142\/wp-json\/wp\/v2\/posts\/891"}],"collection":[{"href":"http:\/\/192.168.0.142\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/192.168.0.142\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/192.168.0.142\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"http:\/\/192.168.0.142\/wp-json\/wp\/v2\/comments?post=891"}],"version-history":[{"count":33,"href":"http:\/\/192.168.0.142\/wp-json\/wp\/v2\/posts\/891\/revisions"}],"predecessor-version":[{"id":941,"href":"http:\/\/192.168.0.142\/wp-json\/wp\/v2\/posts\/891\/revisions\/941"}],"wp:featuredmedia":[{"embeddable":true,"href":"http:\/\/192.168.0.142\/wp-json\/wp\/v2\/media\/249"}],"wp:attachment":[{"href":"http:\/\/192.168.0.142\/wp-json\/wp\/v2\/media?parent=891"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/192.168.0.142\/wp-json\/wp\/v2\/categories?post=891"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/192.168.0.142\/wp-json\/wp\/v2\/tags?post=891"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}